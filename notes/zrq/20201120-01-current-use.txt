#
# <meta:header>
#   <meta:licence>
#     Copyright (c) 2020, ROE (http://www.roe.ac.uk/)
#
#     This information is free software: you can redistribute it and/or modify
#     it under the terms of the GNU General Public License as published by
#     the Free Software Foundation, either version 3 of the License, or
#     (at your option) any later version.
#
#     This information is distributed in the hope that it will be useful,
#     but WITHOUT ANY WARRANTY; without even the implied warranty of
#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#     GNU General Public License for more details.
#
#     You should have received a copy of the GNU General Public License
#     along with this program.  If not, see <http://www.gnu.org/licenses/>.
#   </meta:licence>
# </meta:header>
#
#zrq-notes-time
#zrq-notes-indent
#zrq-notes-crypto
#zrq-notes-ansible
#zrq-notes-osformat
#

    Target:

        List the resources in use

    Result:

        Work in progress ...

# -----------------------------------------------------

    From text chat with Stelios:

        Sure, so currently I have two deploys of the Hadoop/Zeppelin stack on "test"
        One is the deploy that zeppelin.aglais.uk is pointing to, and the second one is a newer deploy where I was going to mount the Ceph share, and hopefully replace the other one
        There is also a third cluster running there which I think you setup
        Overall they are using:
        306GB of 768GB
        19 of 20 instances
        86 of 400 VCPUs (edited)
        4.8TB of 5TB Volume Storage
        And 4 of 6 floating IPs
        we are also close to the limit for routers, security groups & security group rules on test
        Each one of these deploys creates two master nodes, 3 worker nodes, 1 zeppelin node  & 1 gateway node
        The notes on how I deployed the last one, including my attempt at mounting Ceph are here:
        https://github.com/stvoutsin/aglais/blob/stv-ansible-deploy/notes/stv/20201102-automated-deploy.txt

        We also have the old prototype deployed but not running on "dev"
        That is using all of the Volume storage, 80 of 400 CPU  & 278GB of 768GB RAM


# -----------------------------------------------------
# Create a container to work with.
#[user@desktop]

    source "${HOME:?}/aglais.env"

    podman run \
        --rm \
        --tty \
        --interactive \
        --name ansibler \
        --hostname ansibler \
        --env "SSH_AUTH_SOCK=/mnt/ssh_auth_sock" \
        --volume "${SSH_AUTH_SOCK}:/mnt/ssh_auth_sock:rw,z" \
        --env "clouduser=${AGLAIS_USER:?}" \
        --env "cloudname=${AGLAIS_CLOUD:?}" \
        --volume "${HOME:?}/clouds.yaml:/etc/openstack/clouds.yaml:ro,z" \
        --volume "${AGLAIS_CODE:?}/experiments/openstack:/openstack:ro,z" \
        --volume "${AGLAIS_CODE:?}/experiments/hadoop-yarn:/hadoop-yarn:ro,z" \
        --volume "${AGLAIS_CODE:?}/experiments/kubernetes:/kubernetes:ro,z" \
        atolmis/ansible-client:latest \
        bash


# -----------------------------------------------------
# Allocate some resources.
#[root@ansibler]

    /hadoop-yarn/bin/create-all.sh \
        "${cloudname:?}"

--START--
....
....
--END--


# -----------------------------------------------------
# List the current resources.
#[root@ansibler]

    cloudname=gaia-prod

    /openstack/bin/list-all.sh \
        "${cloudname:?}"

--START--

---- ---- ----
File [list-all.sh]
Path [/openstack/bin]
---- ---- ----
Cloud name [gaia-prod]
---- ---- ----

---- ----
Clusters
+--------------------------------------+-----------------------------+------------------+------------+--------------+-----------------+---------------+
| uuid                                 | name                        | keypair          | node_count | master_count | status          | health_status |
+--------------------------------------+-----------------------------+------------------+------------+--------------+-----------------+---------------+
| 80d9110a-34df-4190-b8d1-0646ceee8acc | aglais-k8s-20201120-cluster | zrq-gaia-keypair |          4 |            1 | CREATE_COMPLETE | HEALTHY       |
+--------------------------------------+-----------------------------+------------------+------------+--------------+-----------------+---------------+

---- ----
Servers
+--------------------------------------+---------------------------------------------------+--------+--------------------+-------------------------+-------------------+
| ID                                   | Name                                              | Status | Networks           | Image                   | Flavor            |
+--------------------------------------+---------------------------------------------------+--------+--------------------+-------------------------+-------------------+
| 32e7b720-5814-4330-8642-d0acf881efcd | aglais-k8s-20201120-cluster-nnhkhhgbhuzm-node-3   | ACTIVE | private=10.0.0.237 | FedoraAtomic29-20191126 | general.v1.medium |
| 0aa76b93-65df-4a12-9bf3-ba382907ae81 | aglais-k8s-20201120-cluster-nnhkhhgbhuzm-node-1   | ACTIVE | private=10.0.0.57  | FedoraAtomic29-20191126 | general.v1.medium |
| 370f4838-42c9-4540-a2a2-8a332308799a | aglais-k8s-20201120-cluster-nnhkhhgbhuzm-node-2   | ACTIVE | private=10.0.0.39  | FedoraAtomic29-20191126 | general.v1.medium |
| c9fe3a48-7e4c-4442-b79d-2833a1d507bd | aglais-k8s-20201120-cluster-nnhkhhgbhuzm-node-0   | ACTIVE | private=10.0.0.226 | FedoraAtomic29-20191126 | general.v1.medium |
| edfb8afd-a922-4e62-8c3f-1d87f7556ac1 | aglais-k8s-20201120-cluster-nnhkhhgbhuzm-master-0 | ACTIVE | private=10.0.0.62  | FedoraAtomic29-20191126 | general.v1.tiny   |
+--------------------------------------+---------------------------------------------------+--------+--------------------+-------------------------+-------------------+

---- ----
Volumes


---- ----
Floating addresses
+--------------------------------------+---------------------+------------------+--------------------------------------+--------------------------------------+----------------------------------+
| ID                                   | Floating IP Address | Fixed IP Address | Port                                 | Floating Network                     | Project                          |
+--------------------------------------+---------------------+------------------+--------------------------------------+--------------------------------------+----------------------------------+
| ef03c7e8-2900-4705-866b-ad0a379e80ee | 128.232.227.200     | 10.0.0.217       | 67519f34-89ec-401b-af1c-5bc112b69e53 | a929e8db-1bf4-4a5f-a80c-fabd39d06a26 | 21b4ae3a2ea44bc5a9c14005ed2963af |
+--------------------------------------+---------------------+------------------+--------------------------------------+--------------------------------------+----------------------------------+

---- ----
Routers
+--------------------------------------+--------------------------------------------------------------------------------------+--------+-------+----------------------------------+
| ID                                   | Name                                                                                 | Status | State | Project                          |
+--------------------------------------+--------------------------------------------------------------------------------------+--------+-------+----------------------------------+
| a5d7643c-5100-4c8b-81ad-d545e4b72676 | aglais-k8s-20201120-cephfs-router                                                    | ACTIVE | UP    | 21b4ae3a2ea44bc5a9c14005ed2963af |
| eb234f71-0977-4ef5-ac58-5644788f43d8 | aglais-k8s-20201120-cluster-nnhkhhgbhuzm-network-jp5ny7uxtogc-extrouter-ynqoiqxl5dv3 | ACTIVE | UP    | 21b4ae3a2ea44bc5a9c14005ed2963af |
+--------------------------------------+--------------------------------------------------------------------------------------+--------+-------+----------------------------------+

---- ----
Networks
+--------------------------------------+------------------+----------------------------------------------------------------------------+
| ID                                   | Name             | Subnets                                                                    |
+--------------------------------------+------------------+----------------------------------------------------------------------------+
| 722f0328-f6ef-43da-8873-9bfad9e8337b | private          | 174f44c8-3283-4f58-9c05-f5266d9391a7                                       |
| a929e8db-1bf4-4a5f-a80c-fabd39d06a26 | internet         | 180dc961-c52f-461a-b241-8f7a30d022a5, 273123bb-70f6-4f51-a406-7fc4b446532d |
| ecb791d5-1022-447a-a79c-8f38a0f5c990 | cumulus-internal | 01b76c7c-3c1a-4c5c-9a5a-14bcf6c0c290                                       |
+--------------------------------------+------------------+----------------------------------------------------------------------------+

---- ----
Subnets
+--------------------------------------+-------------------------------------------------------------------------------------------+--------------------------------------+---------------+
| ID                                   | Name                                                                                      | Network                              | Subnet        |
+--------------------------------------+-------------------------------------------------------------------------------------------+--------------------------------------+---------------+
| 01b76c7c-3c1a-4c5c-9a5a-14bcf6c0c290 | cumulus-internal                                                                          | ecb791d5-1022-447a-a79c-8f38a0f5c990 | 10.218.0.0/16 |
| 174f44c8-3283-4f58-9c05-f5266d9391a7 | aglais-k8s-20201120-cluster-nnhkhhgbhuzm-network-jp5ny7uxtogc-private_subnet-yiyn7m6tpgoi | 722f0328-f6ef-43da-8873-9bfad9e8337b | 10.0.0.0/24   |
+--------------------------------------+-------------------------------------------------------------------------------------------+--------------------------------------+---------------+

---- ----
Security groups
+--------------------------------------+----------------------------------------------------------------------------+------------------------+----------------------------------+------+
| ID                                   | Name                                                                       | Description            | Project                          | Tags |
+--------------------------------------+----------------------------------------------------------------------------+------------------------+----------------------------------+------+
| aa63efff-7c67-4f29-ba7c-a1d85695407b | default                                                                    | Default security group | 21b4ae3a2ea44bc5a9c14005ed2963af | []   |
| c85d4939-dae2-4b17-8b84-42c720bbbd9c | aglais-k8s-20201120-cluster-nnhkhhgbhuzm-secgroup_kube_master-mlsfpg6va3ey |                        | 21b4ae3a2ea44bc5a9c14005ed2963af | []   |
| f7e838fc-e38f-449d-b5d6-dcadb9d2b2fc | aglais-k8s-20201120-cluster-nnhkhhgbhuzm-secgroup_kube_minion-6ugfkazaauq3 |                        | 21b4ae3a2ea44bc5a9c14005ed2963af | []   |
+--------------------------------------+----------------------------------------------------------------------------+------------------------+----------------------------------+------+
--END--


# -----------------------------------------------------
# Experiment with some openstack commands ...
#[root@ansibler]

    openstack \
        --os-cloud "${cloudname:?}" \
        limit list

--START--
-
--END--


    openstack \
        --os-cloud "${cloudname:?}" \
        usage list

--START--
Policy doesn't allow os_compute_api:os-simple-tenant-usage:list to be performed. (HTTP 403) (Request-ID: req-64e0eaea-b08f-4eb2-86ed-2a3df30d23d5)
--END--


    openstack \
        --os-cloud "${cloudname:?}" \
        quota list \
            --compute

--START--
You are not authorized to perform the requested action: identity:list_projects. (HTTP 403) (Request-ID: req-db6f9cd0-da8c-479b-be18-6341f25fb044)
--END--


    openstack \
        --os-cloud "${cloudname:?}" \
        project list

--START--
+----------------------------------+----------------+
| ID                               | Name           |
+----------------------------------+----------------+
| 08e24c6d87f94740aa59c172462ed927 | iris-gaia-dev  |
| 190eb5f98d994fcca43e9abb0867d319 | iris           |
| 21b4ae3a2ea44bc5a9c14005ed2963af | iris-gaia-prod |
| bea28e83e6aa47a8962b59c3b24495fe | iris-gaia-test |
+----------------------------------+----------------+
--END--


    openstack \
        --os-cloud "${cloudname:?}" \
        quota show \
            --default '21b4ae3a2ea44bc5a9c14005ed2963af'

--START--
+-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Field                 | Value                                                                                                                                                                                       |
+-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| backup-gigabytes      | 1000                                                                                                                                                                                        |
| backups               | 10                                                                                                                                                                                          |
| cores                 | 0                                                                                                                                                                                           |
| fixed-ips             | -1                                                                                                                                                                                          |
| floating-ips          | 50                                                                                                                                                                                          |
| gigabytes             | 1000                                                                                                                                                                                        |
| gigabytes___DEFAULT__ | -1                                                                                                                                                                                          |
| gigabytes_rbd         | -1                                                                                                                                                                                          |
| groups                | 10                                                                                                                                                                                          |
| health_monitors       | None                                                                                                                                                                                        |
| injected-file-size    | 10240                                                                                                                                                                                       |
| injected-files        | 5                                                                                                                                                                                           |
| injected-path-size    | 255                                                                                                                                                                                         |
| instances             | 10                                                                                                                                                                                          |
| key-pairs             | 100                                                                                                                                                                                         |
| l7_policies           | None                                                                                                                                                                                        |
| listeners             | None                                                                                                                                                                                        |
| load_balancers        | None                                                                                                                                                                                        |
| location              | Munch({'cloud': 'gaia-prod', 'region_name': 'RegionOne', 'zone': None, 'project': Munch({'id': '21b4ae3a2ea44bc5a9c14005ed2963af', 'name': None, 'domain_id': None, 'domain_name': None})}) |
| name                  | None                                                                                                                                                                                        |
| networks              | 100                                                                                                                                                                                         |
| per-volume-gigabytes  | -1                                                                                                                                                                                          |
| pools                 | None                                                                                                                                                                                        |
| ports                 | 500                                                                                                                                                                                         |
| project               | None                                                                                                                                                                                        |
| project_name          | iris-gaia-prod                                                                                                                                                                              |
| properties            | 128                                                                                                                                                                                         |
| ram                   | 51200                                                                                                                                                                                       |
| rbac_policies         | 10                                                                                                                                                                                          |
| routers               | 10                                                                                                                                                                                          |
| secgroup-rules        | 100                                                                                                                                                                                         |
| secgroups             | 10                                                                                                                                                                                          |
| server-group-members  | 10                                                                                                                                                                                          |
| server-groups         | 10                                                                                                                                                                                          |
| snapshots             | 10                                                                                                                                                                                          |
| snapshots___DEFAULT__ | -1                                                                                                                                                                                          |
| snapshots_rbd         | -1                                                                                                                                                                                          |
| subnet_pools          | -1                                                                                                                                                                                          |
| subnets               | 100                                                                                                                                                                                         |
| volumes               | 10                                                                                                                                                                                          |
| volumes___DEFAULT__   | -1                                                                                                                                                                                          |
| volumes_rbd           | -1                                                                                                                                                                                          |
+-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
--END--


    openstack \
        --os-cloud "${cloudname:?}" \
        quota show \
            --default 'iris-gaia-prod'


--START--
You are not authorized to perform the requested action: identity:list_projects. (HTTP 403) (Request-ID: req-b2c9aa6c-cc3e-4b95-891d-22977b4922af)
--END--


    openstack \
        --os-cloud "${cloudname:?}" \
        quota show

--START--
+-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Field                 | Value                                                                                                                                                                                       |
+-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| backup-gigabytes      | 1000                                                                                                                                                                                        |
| backups               | 10                                                                                                                                                                                          |
| cores                 | 400                                                                                                                                                                                         |
| fixed-ips             | -1                                                                                                                                                                                          |
| floating-ips          | 6                                                                                                                                                                                           |
| gigabytes             | 5120                                                                                                                                                                                        |
| gigabytes___DEFAULT__ | -1                                                                                                                                                                                          |
| gigabytes_rbd         | -1                                                                                                                                                                                          |
| groups                | 10                                                                                                                                                                                          |
| health_monitors       | None                                                                                                                                                                                        |
| injected-file-size    | 10240                                                                                                                                                                                       |
| injected-files        | 5                                                                                                                                                                                           |
| injected-path-size    | 255                                                                                                                                                                                         |
| instances             | 20                                                                                                                                                                                          |
| key-pairs             | 100                                                                                                                                                                                         |
| l7_policies           | None                                                                                                                                                                                        |
| listeners             | None                                                                                                                                                                                        |
| load_balancers        | None                                                                                                                                                                                        |
| location              | Munch({'cloud': 'gaia-prod', 'region_name': 'RegionOne', 'zone': None, 'project': Munch({'id': '21b4ae3a2ea44bc5a9c14005ed2963af', 'name': None, 'domain_id': None, 'domain_name': None})}) |
| name                  | None                                                                                                                                                                                        |
| networks              | 100                                                                                                                                                                                         |
| per-volume-gigabytes  | -1                                                                                                                                                                                          |
| pools                 | None                                                                                                                                                                                        |
| ports                 | 500                                                                                                                                                                                         |
| project               | 21b4ae3a2ea44bc5a9c14005ed2963af                                                                                                                                                            |
| project_name          | iris-gaia-prod                                                                                                                                                                              |
| properties            | 128                                                                                                                                                                                         |
| ram                   | 786432                                                                                                                                                                                      |
| rbac_policies         | 10                                                                                                                                                                                          |
| routers               | 4                                                                                                                                                                                           |
| secgroup-rules        | 100                                                                                                                                                                                         |
| secgroups             | 10                                                                                                                                                                                          |
| server-group-members  | 10                                                                                                                                                                                          |
| server-groups         | 10                                                                                                                                                                                          |
| snapshots             | 10                                                                                                                                                                                          |
| snapshots___DEFAULT__ | -1                                                                                                                                                                                          |
| snapshots_rbd         | -1                                                                                                                                                                                          |
| subnet_pools          | -1                                                                                                                                                                                          |
| subnets               | 100                                                                                                                                                                                         |
| volumes               | 20                                                                                                                                                                                          |
| volumes___DEFAULT__   | -1                                                                                                                                                                                          |
| volumes_rbd           | -1                                                                                                                                                                                          |
+-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
--END--


    openstack \
        --os-cloud "${cloudname:?}" \
        quota show \
            --default 'iris-gaia-prod'

--START--
You are not authorized to perform the requested action: identity:list_projects. (HTTP 403) (Request-ID: req-82927768-f4bd-4d00-84fa-e3ec075d3b3f)
--END--


    openstack \
        --os-cloud "${cloudname:?}" \
        quota list \
            --project '21b4ae3a2ea44bc5a9c14005ed2963af' \
            --compute

--START--
You are not authorized to perform the requested action: identity:list_projects. (HTTP 403) (Request-ID: req-6a2d7a8c-2e02-4542-99db-09c26bffe9ba)
--END--


    openstack \
        --os-cloud "${cloudname:?}" \
        quota list \
            --project 'iris-gaia-prod' \
            --compute

--START--
You are not authorized to perform the requested action: identity:list_projects. (HTTP 403) (Request-ID: req-c2c224a7-9349-4553-bc63-6d5d47011147)
--END--


# -----------------------------------------------------
# See if we can get anythng from the heat stack ...
#[root@ansibler]

    openstack \
        --os-cloud "${cloudname:?}" \
        stack list

--START--
+--------------------------------------+------------------------------------------+-----------------+----------------------+--------------+
| ID                                   | Stack Name                               | Stack Status    | Creation Time        | Updated Time |
+--------------------------------------+------------------------------------------+-----------------+----------------------+--------------+
| 2629769c-0f54-436a-9fff-6f908b9db834 | aglais-k8s-20201120-cluster-nnhkhhgbhuzm | CREATE_COMPLETE | 2020-11-20T15:37:16Z | None         |
+--------------------------------------+------------------------------------------+-----------------+----------------------+--------------+
--END--


    openstack \
        --os-cloud "${cloudname:?}" \
        stack resource list \
            '2629769c-0f54-436a-9fff-6f908b9db834'


--START--
+-------------------------------+--------------------------------------+--------------------------------------------------------------------------------------+-----------------+----------------------+
| resource_name                 | physical_resource_id                 | resource_type                                                                        | resource_status | updated_time         |
+-------------------------------+--------------------------------------+--------------------------------------------------------------------------------------+-----------------+----------------------+
| etcd_lb                       | d6fd6d2b-2071-471d-95bc-8d753211dd71 | file:///usr/lib/python2.7/site-packages/magnum/drivers/common/templates/lb_etcd.yaml | CREATE_COMPLETE | 2020-11-20T15:37:17Z |
| secgroup_rule_tcp_kube_minion | 7d75c88b-3164-4d9c-a39f-ae71ebc0903e | OS::Neutron::SecurityGroupRule                                                       | CREATE_COMPLETE | 2020-11-20T15:37:17Z |
| kube_masters                  | 59a7573a-2961-4b31-936f-f35f6e0ac037 | OS::Heat::ResourceGroup                                                              | CREATE_COMPLETE | 2020-11-20T15:37:17Z |
| network                       | 4e12fbbc-9df8-4797-ae76-7c3ed5af901a | file:///usr/lib/python2.7/site-packages/magnum/drivers/common/templates/network.yaml | CREATE_COMPLETE | 2020-11-20T15:37:17Z |
| api_lb                        | bac7760b-a416-46d2-a5a7-394d0a263bd6 | file:///usr/lib/python2.7/site-packages/magnum/drivers/common/templates/lb_api.yaml  | CREATE_COMPLETE | 2020-11-20T15:37:17Z |
| secgroup_kube_minion          | f7e838fc-e38f-449d-b5d6-dcadb9d2b2fc | OS::Neutron::SecurityGroup                                                           | CREATE_COMPLETE | 2020-11-20T15:37:17Z |
| secgroup_rule_udp_kube_minion | 9dfd2eea-3e21-42da-af46-abae0b7502de | OS::Neutron::SecurityGroupRule                                                       | CREATE_COMPLETE | 2020-11-20T15:37:17Z |
| kube_cluster_deploy           | 31f0b3a8-0667-4376-8ae7-75951b5d34c9 | OS::Heat::SoftwareDeployment                                                         | CREATE_COMPLETE | 2020-11-20T15:37:17Z |
| secgroup_kube_master          | c85d4939-dae2-4b17-8b84-42c720bbbd9c | OS::Neutron::SecurityGroup                                                           | CREATE_COMPLETE | 2020-11-20T15:37:17Z |
| master_nodes_server_group     | 834ac01f-8630-4e96-8152-fca84cbfc863 | OS::Nova::ServerGroup                                                                | CREATE_COMPLETE | 2020-11-20T15:37:17Z |
| kube_minions                  | dc733de7-39a4-4b09-bd99-d51427ab338b | OS::Heat::ResourceGroup                                                              | CREATE_COMPLETE | 2020-11-20T15:37:17Z |
| api_address_floating_switch   | ba9bb378-d71f-441d-bc8b-fd8fc707250a | Magnum::FloatingIPAddressSwitcher                                                    | CREATE_COMPLETE | 2020-11-20T15:37:17Z |
| kube_cluster_config           | c906656c-b946-4d77-a073-76331837520f | OS::Heat::SoftwareConfig                                                             | CREATE_COMPLETE | 2020-11-20T15:37:17Z |
| worker_nodes_server_group     | e34ccf85-6f12-4039-8fe5-2a1c1028a401 | OS::Nova::ServerGroup                                                                | CREATE_COMPLETE | 2020-11-20T15:37:17Z |
| api_address_lb_switch         | 44d02223-e2c0-45a8-bb74-06a1f164afc3 | Magnum::ApiGatewaySwitcher                                                           | CREATE_COMPLETE | 2020-11-20T15:37:17Z |
| etcd_address_lb_switch        | 4650a943-2fc1-4d43-8618-81e50c091c21 | Magnum::ApiGatewaySwitcher                                                           | CREATE_COMPLETE | 2020-11-20T15:37:17Z |
+-------------------------------+--------------------------------------+--------------------------------------------------------------------------------------+-----------------+----------------------+
--END--



